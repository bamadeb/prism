{% extends 'basic.html' %}
{% block title%} PRISM  :: MYWORK {% endblock %}
{% load static %}
{% block body %}
<main id="main" class="main" style="margin-top:50px!important;min-height:550px;">
   <section class="section dashboard">
      <div class="row">
         <!-- Left side columns -->
         <div class="col-lg-12">
            <div class="row">
               {% for item in prismWorkspacekpi %}
               <div class="col-xl-4 col-sm-4 mb-xl-0">
                  <div class="card">
                     <div class="card-body">
                        <div class="row">
                           <div class="col-12"> <h3 align="center">{{ item.period }}</h3> </div>
                           <div class="col-4">
                              <h4 align="center" style="color:red;">CALLED</h4> <br>
                              <div align="center"><h5>{{ item.called }}</h5></div>
                           </div>
                           <div class="col-4"> <h4 align="center" style="color:blue;">REACHED</h4><br>
                              <div align="center"><h5>{{ item.reached }}</h5></div> </div>
                           <div class="col-4"> <h4 align="center" style="color:green;">ENGAGED</h4><br>
                              <div align="center"><h5>{{ item.engaged }}</h5></div> </div>


                        </div>
                     </div>
                  </div>
               </div>
               {% endfor %}
            </div>


            <div class="row">
               <div class="col-xl-6 col-sm-6 mb-xl-0">
                  <div class="card">
                     <div class="card-body">
                        <div class="row">
                           <div class="col-6"> <h3 align="center">ENROLLED</h3> </div>
                           <div class="col-1"> : </div>
                           <div class="col-5"> <h3 align="center">{{ kpis_data.0.enrolledCnt }}</h3></div>

                        </div>
                     </div>
                  </div>
               </div>
               <div class="col-xl-6 col-sm-6 mb-xl-0">
                  <div class="card">
                     <div class="card-body">
                        <div class="row">
                           <div class="col-6"> <h3 align="center">ENGAGED</h3> </div>
                           <div class="col-1"> : </div>
                           <div class="col-5"> <h3 align="center">{{ kpis_data.0.engagedCnt }}</h3></div>
                        </div>

                     </div>
                  </div>
               </div>
            </div>


            <div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-body">

        <!-- Nav Tabs -->
<ul class="nav nav-tabs" id="myTab" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile" type="button" role="tab" aria-controls="profile" aria-selected="true">MEMBERS</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="home-tab" data-bs-toggle="tab" data-bs-target="#home" type="button" role="tab" aria-controls="task" aria-selected="false">TASKS</button>
  </li>
</ul>
<!--        <ul class="nav nav-tabs" id="myTab" role="tablist">-->
<!--          <li class="nav-item" role="presentation">-->
<!--            <button class="nav-link active" id="profile-tab" data-toggle="tab" data-target="#profile" type="button" role="tab" aria-controls="profile" aria-selected="true">MEMBERS</button>-->
<!--          </li>-->
<!--          <li class="nav-item" role="presentation">-->
<!--            <button class="nav-link" id="home-tab" data-toggle="tab" data-target="#home" type="button" role="tab" aria-controls="task" aria-selected="false">TASKS</button>-->
<!--          </li>-->
<!--          <li class="nav-item" role="presentation">-->
<!--            <button class="nav-link" id="referred-tab" data-toggle="tab" data-target="#referred" type="button" role="tab" aria-controls="referred" aria-selected="false">TRANSFERRED LIST</button>-->
<!--          </li>-->
<!--          <li class="nav-item" role="presentation">-->
<!--            <button class="nav-link" id="transportation-tab" data-toggle="tab" data-target="#transportation" type="button" role="tab" aria-controls="transportation" aria-selected="false">TRANSPORTATION LIST</button>-->
<!--          </li>-->
<!--        </ul>-->

        <div class="tab-content pt-2" id="myTabContent">

          <!-- TASKS TAB -->
          <div class="tab-pane " id="home" role="tabpanel" aria-labelledby="home-tab">
            <table class="table table-borderless" id="tasks">
              <thead>
                <tr>
                  <th width="5%"></th>
                  <th>DATE</th>
                  <th>STATUS</th>
                  <th>ASSIGN TO</th>
                  <th>ADDED BY</th>
                  <th style="text-align:center;">COMPLETED DATE</th>
                  <th align="center">ACTION</th>
                </tr>
              </thead>
              <tbody>
                {% for task in task_list %}


                  <tr class="gradeX trbg">
                    <td align="center">
  <div style="border-radius:50%;
              background-color:{{ task.color }};
              width:14px;height:14px;">
  </div>
</td>

                    <td>{% if task.action_date %}{{ task.action_date|date:"m/d/Y" }}{% endif %}</td>
                    <td><a href="javascript:void(0);">{{ task.status }}</a></td>
                    <td>{{ task.FistName }} {{ task.LastName }}</td>
                    <td align="center">{{ task.initial }}</td>
                    <td align="center">{{ task.completed_date }}</td>
                    <td>
                      {% if task.status != "Successful" and task.status != "Close" %}
                        <a style="cursor:pointer;" title="Action Change" data-toggle="modal" data-backdrop="static" data-target="#action_change"
                           onclick="action_change('Update','{{ task.action_date|date:'m/d/Y' }}','{{ task.id }}','{{ task.status }}','{{ task.action_note }}','{{ task.assign_to }}','{{ task.medicaid_id }}');">
                          <i class="bi bi-pencil" aria-hidden="true"></i>
                        </a>
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <!-- MEMBERS TAB -->
          <div class="tab-pane show active" id="profile" role="tabpanel" aria-labelledby="profile-tab">
            <table class="table table-sm table-borderless" id="members">
              <thead>
                <tr>
                  <th>#MEMBER ID</th>
                  <th>NAME</th>
                  <th>PHONE</th>
                  <th>ALERT</th>
                  <th>#CALL</th>
                  <th></th>
                  <th>ELIGIBILITY</th>
                  <th>3RD CALL</th>
                  <th>2ND CALL</th>
                  <th>LAST CALL</th>
                  <th>NEXT ACTIVITY</th>
                  <th></th>
                  <th>APP. DATE</th>
                  <th></th>
                  <th>EVENT DATE</th>
                  <th></th>
                  <th align="right">ACTION</th>
                </tr>
              </thead>
              <tbody>
                {% for member in members %}
                  <tr>
                    <th><a class="text-primary">#{{ member.medicaid_id }}</a></th>
                    <td><a class="text-primary">{{ member.FIRST_NAME }} {{ member.LAST_NAME }}</a></td>
                    <td><a class="text-primary">{{ member.HOME_PHONE|default:'' }}</a></td>

                    <!-- Alerts -->
                    <td>
                      <span class="badge alert_bg1 wrapper">

<!--  {# Count alerts first #}-->
<!--  {% with 0 as alertCount %}-->
<!--    {% for alert in alertList %}-->

<!--      {% if member.medicaid_id == alert.medicaid_id %}-->

<!--        {% widthratio 1 1 1 as inc %} {# a trick to add numbers #}-->

<!--        {% with alertCount|add:inc as alertCount %}{% endwith %}-->

<!--      {% endif %}-->

<!--    {% endfor %}-->

<!--  {% endwith %}-->

  {# Show notification bell if member.alertCount > 0 #}
  {% if member.alertCount > 0 %}
    <div style="position:absolute;margin-left: 21px;margin-top: -15px;">
      <img src="{% static 'images/notification.png' %}" width="16">
    </div>
  {% endif %}

  <div class="">{{ member.alertCount }}
    <div class="tooltip">
      <div style="overflow-y:scroll; height: 180px !important;">
        <table class="table table-sm" style="font-size:12px;">
          {% if member.alertCount == 0 %}
            <tr><td colspan="2" align="center">No alert found</td></tr>
          {% else %}
            {% for alert in alertList %}
              {% if member.medicaid_id == alert.medicaid_id and today|date:"U" <= alert.due_date|date:"U" %}
                <tr>
                  <td>
                    {{ alert.alert }} - {{ alert.alert_type }}<br>

                    {% if today|date:"U" > alert.due_date|date:"U" %}
                        {{ alert.due_date|date:"m/d/y" }}  {# expired -> highlight #}
                        {% with "#e63b3b !important" as color %}
                        {% endwith %}
                    {% else %}
                        {{ alert.due_date|date:"m/d/y" }}  {# still valid #}
                        {% with "" as color %}
                        {% endwith %}
                    {% endif %}
                  </td>
                  <td>
                    <span style="background-color:{{ color }}" class="badge alert_bg tooltipbox">
                      {{ alert.alert_status }}
                    </span>
                  </td>
                </tr>
              {% endif %}
            {% endfor %}
          {% endif %}
        </table>
      </div>
    </div>
  </div>

</span>

                    </td>

                    <!-- Call Count -->
                    <td>
                      <a class="text-primary" style="cursor:pointer;" onclick="showCallList('{{ member.medicaid_id }}');">
                        {{ member.Call_count }}
                      </a>
                    </td>
                     <td></td>
                    <!-- Eligibility trst -->
                    <td>
                      {% if member.ELIG_EXP_DT %}
                        {% if member.ELIG_EXP_DT < today %}
                          <div align="center">
                            <div style="width:17px;height:17px;border-radius:50%;margin:2px 43px 0px 0px;" class="bg-danger"></div>
                          </div>
                            {{ member.ELIG_EXP_DT|date:"m/d/Y" }}
                        {% elif member.ELIG_EXP_DT <= today|add:"30 days" %}
                          <div align="center">
                            <div style="width:17px;height:17px;border-radius:50%;margin:2px 43px 0px 0px;" class="bg-warning"></div>
                          </div>
                            {{ member.ELIG_EXP_DT|date:"m/d/Y" }}
                        {% endif %}

                      {% endif %}
                    </td>
                     <td>{% if member.third_last_action_date %}
                         {{ member.third_last_action_date|date:"m/d/Y" }}
                        {% endif %}</td>
                     <td>{% if member.second_last_action_date %}
                         {{ member.second_last_action_date|date:"m/d/Y" }}
                        {% endif %}</td>
                     <td>{% if member.last_action_date %}
                         {{ member.last_action_date|date:"m/d/Y" }}
                        {% endif %}</td>
                     <td></td>
                     <td></td>
                     <td></td>
                     <td></td>
                    <!-- Appointment -->
                    <td>{% if member.appointment_date %}{{ member.appointment_date|date:"m/d/Y" }}{% endif %}</td>

                    <!-- RSVP -->
                    <td>{% if member.rsvp_appointment_date %}{{ member.rsvp_appointment_date|date:"m/d/Y" }}{% endif %}</td>

                    <!-- Actions -->
                    <td align="right">
                      <a target="_blank" href="{% url 'memberdetails' member.medicaid_id %}">
                        <i title="Member Details" class="fa fa-eye"></i>
                      </a>
                      <a target="_blank" href="{% url 'history' member.medicaid_id %}">
                        <i title="Member History" class="fa fa-history"></i>
                      </a>
                      <a href="javascript:void(0);" onclick="addAction('{{ member.medicaid_id }}');" class="text-primary">+<i class="fa fa-phone"></i></a>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <!-- REFERRED LIST TAB -->
          <div class="tab-pane " id="referred" role="tabpanel" aria-labelledby="referred-tab">
            <table class="table table-borderless" id="transferList">
              <thead>
                <tr>
                  <th>#MEMBER ID</th>
                  <th>TRANSFERRED BY</th>
                  <th>TRANSFERRED TO</th>
                  <th>TRANSFER DATE</th>
                  <th>TRANSFER REASON</th>
                </tr>
              </thead>
              <tbody>
                {% for ref in refared_member_list %}
                  <tr>
                    <td><a href="javascript:void(0);">#{{ ref.medicaid_id }}</a></td>
                    <td>{{ ref.user_name }}</td>
                    <td>{{ ref.medical_user }}</td>
                    <td>{% if ref.add_date %}{{ ref.add_date|date:"m/d/Y" }}{% endif %}</td>
                    <td>{{ ref.referring_reason }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <!-- TRANSPORTATION TAB -->
          <div class="tab-pane " id="transportation" role="tabpanel" aria-labelledby="transportation-tab">
            <table class="table table-striped table-bordered" id="transportation_prior_list_table_id">
              <thead>
                <tr>
                  <th>MEMBER ID</th>
                  <th>FIRST NAME</th>
                  <th>LAST NAME</th>
                  <th>PHONE</th>
                  <th>ADDRESS</th>
                  <th>DATE & TIME</th>
                  <th>VENDOR</th>
                </tr>
              </thead>
              <tbody>
                {% for transport in all_3day_transport_list %}
                  <tr>
                    <td>{{ transport.medicaid_id }}</td>
                    <td>{{ transport.FIRST_NAME }}</td>
                    <td>{{ transport.LAST_NAME }}</td>
                    <td>{{ transport.HOME_PHONE }}</td>
                    <td>{{ transport.ADDR1 }}</td>
                    <td>
                      {% if transport.action_date %}{{ transport.action_date|date:"m/d/Y" }}{% endif %}
                      ({{ transport.action_time }})
                    </td>
                    <td>{{ transport.schedule_type }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

        </div><!-- End tab-content -->
      </div>
    </div>
  </div>
</div>

         </div><!-- End Left side columns -->


         <div class="col-lg-6">
            <!-- Recent Activity -->
            <div class="card">
               <div class="filter">
                  <a class="icon" href="#" data-toggle="dropdown"><i class="bi bi-three-dots"></i></a>
                  <ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow">
                     <li class="dropdown-header text-start">
                        <h6>Filter</h6>
                     </li>
                     <li><a class="dropdown-item" href="#">Today</a></li>
                     <li><a class="dropdown-item" href="#">This Month</a></li>
                     <li><a class="dropdown-item" href="#">This Year</a></li>
                  </ul>
               </div>

                           <div class="card-body">
              <h5 class="card-title">Recent Activity <span>| Today</span></h5>
              <div class="activity">
                {% for recent in recent_activity %}

                  <div class="activity-item row">
                    <div class="activite-label col-lg-4">
                      {{ recent.add_date|date:"M d Y H:i" }}
                    </div>
                    <div class="col-lg-1">
                      <i class="bi bi-circle-fill activity-badge text-primary align-self-start"></i>
                    </div>
                    <div class="activity-content col-lg-7">
                      #{{ recent.medicaid_id }}: {{ recent.log_name }}, {{ recent.log_details }}
                    </div>
                  </div> <!-- End activity item-->
                {% endfor %}
              </div>
            </div>
            </div><!-- End Recent Activity -->
         </div>

         <!-- Right side columns -->
         <div class="col-lg-6">

            <!-- Alerts -->
            <div class="card">
               <div class="filter">
                  <a class="icon" href="#" data-toggle="dropdown"><i class="bi bi-three-dots"></i></a>
                  <ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow">
                     <li class="dropdown-header text-start">
                        <h6>Filter</h6>
                     </li>
                     <li><a class="dropdown-item" href="#">Today</a></li>
                     <li><a class="dropdown-item" href="#">This Month</a></li>
                     <li><a class="dropdown-item" href="#">This Year</a></li>
                  </ul>
               </div>
                <div class="card-body">
                  <h5 class="card-title">Alerts <span>| Today</span></h5>
                  <div class="activity">
                    <div class="row">
                      {% for alert in alert_count %}
                        <div class="col-lg-4 mt-2 mb-3" style="border-bottom: 1px solid #ccc;">
                          {{ alert.alert }}
                        </div>
                        <div class="col-lg-2 mb-3" style="border-bottom: 1px solid #ccc;">
                          <span class="badge alert_bg1">{{ alert.alert_count }}</span>
                        </div>
                      {% endfor %}

                      {# If odd number of alerts, add blank columns #}
                      {% if alert_count|length|divisibleby:2 == False %}
                        <div class="col-lg-4 mt-2 mb-3" style="border-bottom: 1px solid #ccc;"></div>
                        <div class="col-lg-2 mb-3" style="border-bottom: 1px solid #ccc;"></div>
                      {% endif %}
                    </div>
                  </div>
                </div>


            </div><!-- End Recent Activity -->
         </div><!-- End Right side columns -->

      </div>
   </section>
</main>
<!-- Call list modal start -->
<div class="modal " id="callList" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title"><span></span> Engagement List</h4>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <table class="table table-sm">
          <thead>
            <tr>
              <th>Sl.No</th>
              <th>DATE</th>
              <th>ACTION</th>
              <th>OUTCOME</th>
              <th>NOTE</th>
            </tr>
          </thead>
          <tbody id="callList_table_body">
            <!-- dynamically injected rows -->
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
<!-- Call list modal end -->


<script type="text/javascript">
  $('#members').DataTable({
    aaSorting: [[5, 'desc'], [10,'desc'], [12,'desc'], [14,'desc']],
    columnDefs: [{
      target: 5,
      visible: false
    },{
      target: 10,
      visible: false
    },{
      target: 12,
      visible: false
    },{
      target: 14,
      visible: false
    }]
  });
  $('#tasks').DataTable();
  $('#transferList').DataTable();
  $('#transportation_prior_list_table_id').DataTable();

<!--  $('.datepicker').datepicker({ changeMonth: true,changeYear: true });-->
function showCallList(medicaid_id) {
  if (medicaid_id) {
    $.ajax({
      type: "POST",
      url: "{% url 'get_call_history' %}",   // Django URL
      data: {
        medicaid_id: medicaid_id,
        csrfmiddlewaretoken: '{{ csrf_token }}'   // Django CSRF token
      },
      success: function (response) {
        if (response.statusCode === 200 && response.data.length > 0) {
          $("#callList_table_body").empty();

          response.data.forEach((row, i) => {
            let mydate = new Date(row.action_date);
            let action_date =
              (mydate.getMonth() + 1) + "/" + mydate.getDate() + "/" + mydate.getFullYear();

            // ✅ Handle null values (if null → empty string)
            let action_type = row.action_type ?? "";
            let action_result = row.action_result ?? "";
            let action_note = row.action_note ?? "";

            $("#callList_table_body").append(
              "<tr><td>" + (i + 1) + "</td>" +
              "<td>" + action_date + "</td>" +
              "<td>" + action_type + "</td>" +
              "<td>" + action_result + "</td>" +
              "<td>" + action_note + "</td></tr>"
            );
          });
        } else {
          $("#callList_table_body").html(
            "<tr><td colspan='5' class='text-center'>No records found</td></tr>"
          );
        }

        // ✅ Bootstrap 5 modal show
        var myModal = new bootstrap.Modal(document.getElementById('callList'));
        myModal.show();
      },
      error: function () {
        alert("Action Result Not found.");
      }
    });
  }
}

</script>
{% endblock %}

